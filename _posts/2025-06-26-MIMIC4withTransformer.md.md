---
layout: single
title: MIMIC-IV 데이터를 Transformer 를 활용하여 처치 및 시술 등의 순서 추천 모델 개발
excerpt: 치료의 조합보다 순서에 집중하는 모델
mathjax: true
toc: true
toc_sticky: true
toc_label: Code
categories: Research
tags:
  - DL
  - ML
  - Bio
---
## Idea
데이터베이스 강의에서 팀 프로젝트 과제로 MIMIC-IV 데이터를 활용해 데이터 분석하는 프로젝트가 있었는데, 치료라는 것이 "같은 조합의 처치이더라도 다른 순서로 받았을 때의 결과는 과연 같을까?" 라는 개인적인 아이디어에서 시작되어 따로 연구를 하게 되었다. ~~팀 프로젝트에는 Tabular 데이터 처리에 용이한 FT-Transformer 를 통해 사망률을 예측하는 것으로 아이디어를 내고, LLM 을 통해 MIMIC-IV 임상노트를 학습해 멀티모달로 결합하는 것으로 진행했다.~~ 

## Details
연구 정의: 환자 정보(나이, 몸무게, 성별, 진단명 등)와 시계열적 이벤트 정보(순서가 중요)를 보고 처치 순서 추천 및 생존률 예측.

사용 데이터: MIMIC-IV

데이터 전처리 포인트: 처치 정보 사용에 제한을 두지 않고, 모든 기간의 정보를 활용. 시간 정보는 한 환자에 대해 데이터를 구성할 때, 처치/투여/시술 등의 이벤트들의 순서를 맞추기 위해서만 사용됨.

사용 모델: Transformer, 커스텀 Survival Predictor 

모델의 주요 학습 포인트: 환자 정보(나이, 몸무게, 성별, 진단명)와 처치/투여/시술 등의 순서가 갖는 생존 여부를 학습.

모델의 최종 목표: 현재 이 환자에게 권장되는 순서의 처치나 투여를 추천해주고, 이 순서를 따라 치료를 진행했을 때에 예측되는 생존률(or 사망률)은 몇 퍼센트인지 출력.

## Data EDA
#### admissions.csv
- `subject_id` 환자 개개인을 식별하는 고유 ID이며, 다른 테이블과 정보를 연결하는 데 사용된다.
- `hadm_id` 병원 입원을 식별하는 고유 ID로, 이 모델 분석의 중심이 되는 기본 키이다.
- `admittime` 환자의 입원 시간 정보이며, 이벤트들의 시간 순서를 정렬하는 기준점으로 사용된다.
- `hospital_expire_flag` 환자의 입원 중 사망 여부를 0 또는 1로 나타내며, 우리 모델이 최종적으로 예측해야 할 목표이다.

#### patients.csv
- `subject_id` 환자 고유 ID이며, 입원 정보와 연결하는 데 사용된다.
- `gender` 환자의 성별 정보이며, 모델에 입력되는 고정 피처 중 하나로 토큰화된다.
- `anchor_age` 환자의 나이 정보이며, 10대 단위로 구간화되어 모델에 입력되는 고정 피처로 사용된다.

#### diagnoses_icd.csv
- `hadm_id` 어떤 입원 기록에 해당하는 진단인지 연결해주는 키이다.
- `icd_code` 국제질병분류 진단 코드를 의미하며, 환자의 초기 상태를 정의하는 핵심 정보로 토큰화된다.

#### prescriptions.csv
- `hadm_id` 어떤 입원 기록에 해당하는 처방인지 연결해주는 키이다.
- `starttime` 약물 투여 시작 시간이며, 처치 이벤트들의 순서를 결정하는 기준 시간으로 사용된다.
- `drug` 처방된 약물의 이름이며, 시간에 따라 변화하는 핵심 이벤트 정보로 토큰화되어 시퀀스를 구성한다.

#### procedures_icd.csv
- `hadm_id` 어떤 입원 기록에 해당하는 시술인지 연결해주는 키이다.
- `chartdate` 시술이 기록된 날짜이며, 다른 이벤트들과의 순서를 결정하는 기준 시간으로 사용된다.
- `icd_code` 국제질병분류 시술 코드를 의미하며, 시간에 따라 변화하는 핵심 이벤트 정보로 토큰화되어 시퀀스를 구성한다.

## Pipeline
#### Phase 1: 생존률 예측 모델 구축 (Foundation)
Phase 1 은 주어진 환자 정보와 이벤트 시퀀스에 대한 생존률을 정확하게 예측하는 Transformer 모델을 개발하는 것을 메인으로 진행된다.

**1단계: 코호트 정의 및 데이터 추출 (Cohort & Data Extraction)**
	MIMIC-IV에서 분석 대상 환자군(코호트)을 정의하고, 필요한 모든 테이블에서 데이터를 추출하여 결합.
        
**2단계: 피처 엔지니어링 및 통합 사전 구축 (Feature Engineering & Vocabulary)**
    환자의 고정 정보(나이, 몸무게, 성별, 진단명 등)와 시계열 이벤트(처방, 시술 등)를 전처리.
    모든 이벤트를 고유한 정수 토큰으로 매핑하는 통합 단어장(Vocabulary)을 생성.
        
**3단계: 환자별 시퀀스 생성 및 입력 데이터 구성 (Sequence Generation)**
	각 환자별로 [고정 정보 토큰] + [시계열 이벤트 토큰] 형태의 통합 시퀀스를 생성.
	모델 학습에 필요한 최종 입력 텐서(input_ids, attention_mask 등)를 구성.
        
**4단계: Transformer 예측 모델 아키텍처 설계 (Model Architecture)**  
	생성된 시퀀스를 입력받아 생존률(0~1 사이의 값)을 출력하는 Transformer 기반 모델을 PyTorch로 설계.
        
**5단계: 모델 학습 및 평가 (Training & Evaluation)**
    구성된 데이터셋으로 모델을 학습시키고, AUROC, AUPRC 등의 지표로 예측 성능을 검증.

#### Phase 2: 처치 순서 추천 시스템 구현 (Advanced Goal)
Phase 2는 예측 모델후 완성 후 이를 활용하여 처치 순서를 추천하도록 시스템 구현을 메인으로 진행한다.

**6단계: 추천 전략 수립 및 구현 (Recommendation Strategy)** 
	단순히 학습된 모델로 한 번 예측하고 끝나는 것이 아니라, 이 모델을 일종의 시뮬레이터로 활용하는 것이 이 단계의 핵심이다. 즉, 환자의 현재 상태를 기반으로 앞으로 가능한 모든 처치들을 가상으로 적용해보며 어떤 경로가 가장 높은 생존률로 이어지는지를 탐색하는 방식이다.
	이때, 매 단계에서 가장 좋아 보이는 단 하나의 선택지만을 따르는 탐욕적(Greedy) 접근법은 단기적인 최적해에 갇힐 위험이 있다. 이를 보완하기 위해, 가장 유망한 상위 몇 개의 경로(beam)를 동시에 고려하며 탐색을 이어나가는 빔 서치(Beam Search) 전략을 채택했다.

빔 서치의 과정은 다음과 같다.

1. **초기 상태 설정:** 추천을 시작할 환자의 고정 정보(나이, 성별 등)와 초기 진단명으로 기본 시퀀스를 구성한다.
    
2. **경로 확장 및 평가:** 현재의 유망한 경로들 각각에 대해, 가능한 모든 처치/시술 후보군을 하나씩 추가하여 확장된 가상 경로들을 생성한다. 그리고 Phase 1에서 학습된 커스텀 `SurvivalPredictor` 모델을 통해 각 가상 경로의 예측 생존률을 평가한다.
    
3. **경로 선택:** 평가된 생존률을 기준으로 가장 점수가 높은 상위 N개(Beam Width)의 경로만을 남기고 나머지는 폐기한다.
    
4. **반복:** 원하는 길이의 처치 시퀀스가 생성될 때까지 2, 3번 과정을 반복한다.

이 과정을 통해 최종적으로 가장 높은 생존 확률을 보인 시퀀스를 추천 처치 순서로 제시하고, 해당 확률 값을 함께 출력하여 의사결정을 지원하는 것을 목표로 한다.

